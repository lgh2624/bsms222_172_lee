---
title: "Assignment 1"
output: html_notebook
---
```{r}
# install.packages("ggThemeAssist")
```

# 1. 질문 선정
유전병(모든 유전적 형질)은 이형접합체에서 발현되면 우성(Dominant)이고 발현되지 않으면 열성(Recessive)이라 한다. 우성과 열성을 구분하는 요소가 있을까? 특정 유전형질, 이번 note에서는 발달기 유전질환을 중심으로 탐구할 것이다.


# 2. 데이터 준비
이번 과제에서 필요한 라이브러리로는 다음의 것들이 필요하다:
```{r}
library(tidyverse)
library(purrr)
library(ggplot2)
library(ggridges)
library(cowplot)
```

먼저 DDG2P와 HPO의 데이터를 불러온다.
```{r}
DDG2P <- read_delim("/cloud/project/DDG2P_24_9_2019.with_pLI.txt",
                    delim='\t', progress = F)
HPO <- read_delim("/cloud/project/table.hpo_obo_20190924.txt",
                  delim='\t', progress = F)
```

HPO는 The Human Phenotype Ontology의 약자로 각 질환의 phenotype을 기술하는 용어와 이를 상징하는 코드를 담고 있다.
우리가 알고 싶은 내용은 유전 질환의 우성, 열성 여부이다. 이때, 성염색체는 제외하고 상염색체(Autosomal)의 우열만을 검색해보자.
```{r}
HPO %>% filter(grepl("Autosomal", name))
```
상염색체 우성(AD)는 HP:0000006, 상염색체 열성(AR)은 HP:0000007을 id로 가진다. 나머지 다섯 가지는 실제로 DDG2P에서 검색되지 않으므로 제외하도록 한다.

## 2.1 장기 특이적 리스트

그럼 유전질환의 우열을 따질때, 어떤 변수를 생각해볼 수 있을까? DDG2P에는 `organ specificity list`라는 column이 있다. 유전질환이 발현되는 장기의 목록으로 `;`으로 구분되어 있는 string이다.
어떤 장기가 포함되어 있는지 알 수 없으므로 이를 목록화 하도록 한다.
```{r}
organ_list <- DDG2P %>% 
  filter(!is.na(`organ specificity list`)) %>%
  .$`organ specificity list` %>% # `organ specificity list`를 선택한다
  paste(collapse = ';') %>% # 각 원소를 ';'으로 잇는다.
  strsplit(";") # ';'기준으로 split한 array를 만든다.

head(organ_list[[1]]) # output 1

organ_list <- as.data.frame(organ_list[[1]]) # column 이름이 'organ'인 data frame을 만든다.
colnames(organ_list) <- c("organ") 

organ_list <- count(organ_list, organ) # 종류별로 count한다.
organ_list # output 2
```

DDG2P에서 다루는 장기의 종류는 25종류임을 알 수 있다.
이때, 발현되는 유전질환의 종류가 적은 9개 기관을 제외하고, `Eye`를 포함하는 항목은 모두 `Eye`에 포함시키도록 했다.
```{r}
except <- c("Cancer predisposition",
            "Endocrine",
            "Eye: Lens",
            "Eye: Retina",
            "Hair/Nails",
            "Liver",
            "Lungs",
            "Multisystem",
            "Genitalia",
            "Peripheral nerves",
            "Respiratory tract")

organ_list <- organ_list %>% filter(!(organ %in% except))
organ_list
```

먼저 우성, 열성 유전되는 전체 유전자수를 조사해보자:
```{r}
d <- bind_rows(
  DDG2P %>% filter(
    grepl('HP:0000006', .$phenotypes) & !grepl('HP:0000007', .$phenotypes)) %>%
    mutate(type = 'AD'),
  
  DDG2P %>%  filter(
    !grepl('HP:0000006', .$phenotypes) & grepl('HP:0000007', .$phenotypes)) %>%
    mutate(type = 'AR')
  )

d %>% ggplot(aes(type, fill = type)) +
  geom_bar() +
  theme(legend.position = "none") +
  coord_flip()
```
대략 열성 유전이 우성 유전의 두배 가량이 되는 것을 알 수 있다.

그렇다면 이런 경향성이 모든 장기에 대해 비슷하게 나타날까? 각 장기별 우성, 열성 유전자의 개수는 다음과 같다.
```{r}
organs <- mutate(
  organ_list,
  n = lapply(organ_list$organ, function(x){
    nrow(filter(DDG2P, grepl(x, `organ specificity list`)))})) # 각 장기에서 발현되는 유전질환의 개수를 세어 column 'n'에 저장

organs <- rbind(
  mutate(organ_list, type = "AD", # column 'type'에 "AD"를 입력하고
    freq = lapply(organ_list$organ, function(x){ # 각 장기에서 발현되는 우성유전질환의 개수를 'freq'에 저장
      nrow(filter(DDG2P, grepl("HP:0000006", phenotypes) &
                    !grepl('HP:0000007', phenotypes) &
                    grepl(x, `organ specificity list`)))})),
  
  mutate(organ_list, type =  "AR", # column 'type'에 "AR"를 입력하고
    freq = lapply(organ_list$organ, function(x){ # 각 장기에서 발현되는 열성유전질환의 개수를 'freq'에 저장
      nrow(filter(DDG2P, !grepl("HP:0000006", phenotypes) &
                    grepl('HP:0000007', phenotypes) &
                    grepl(x, `organ specificity list`)))}))
)
organs <- organs %>%
  mutate(organ = as.factor(organs$organ),
         freq = as.numeric(organs$freq))

organs
```

이를 그래프로 나타내면,
```{r}
organs %>% 
  ggplot(aes(reorder(organ, desc(n)))) +
  geom_bar(aes(y = c(n[1:14], rep(0,14)), fill = 'Total'),
           stat = "identity") +
  geom_bar(aes(y = freq, fill = type),
           stat = "identity", position = "dodge") +
  labs(x = "organs",
       y = "number of genes",
       legend = "Types",
       title = "Organ Specific Numer of Dominant/Reccesive Genes") +
  theme(axis.text.x = element_text(size=8, angle = 45, hjust = 1, vjust = 1)) +
  scale_fill_manual(name = "Types", values = c('#f8766d', '#00bfc4', 'grey'))
```

이 그래프는 단순히 유전자의 개수를 나타냈으므로 경향을 파악하기 어렵다. 따라서 이를 비율로 나타내면, 다음과 같다.
```{r}
organs <- mutate(organs, rate = freq / n)
organs %>%
  ggplot(aes(organ)) +
  geom_bar(aes(y = c(rep(1, 14), rep(0, 14))), fill = 'grey', stat = "identity") +
  geom_bar(aes(y = rate,  fill = type), stat = "identity") +
  labs(x="organs", y= "rates", title = "Organ Specific Gene Dominant/Reccesive Ratio") +
  
  theme(axis.text.x = element_text(size=8, angle = 45, hjust = 1, vjust = 1))
```
즉, 장기별로 유전자의 우열의 경향성을 나타내지는 않는다.

## 2.2 pLI
pLI는 유전자가 기능 상실에 대해 얼마나 내성이 적은지 나타내는 지표이다. (probability of that a gene is intolerant to a Loss of Function (LoF) mutation) 0-1 정도의 값으로 계산되며 높을 수록 기능 상실 내성이 적고 (LoF intolerant) 작을 수록 내성이 크다 (LoF tolerant).
pLI가 우성과 열성 유전을 가르는 데 영향을 미칠 것이라고 생각하여 유전자의 pLI 분포에 대해 조사하고자 한다.

먼저 주어진 dataset의 pLI를 그래프로 나타내면 다음과 같이 나타난다.
```{r}
d %>% ggplot(aes(x = pLI)) +
  geom_density(aes(fill = type), alpha = 0.7, position = "stack") +
  theme(legend.position = "none")

d %>% ggplot(aes(x = pLI)) +
  geom_density_ridges(aes(y= type, fill = type), jittered_points = TRUE, 
                      position = position_points_jitter(width = 0.05, height = 0),
                      point_shape = '|', point_size = 3, point_alpha = 0.2, alpha = 0.7, scale = 1.3) +
  theme_ridges() +
  theme(legend.position = "none")
```
우성 유전 유전자는 그래프가 1 근처에서 최대이고, 열성유전 유전자는 0 근처에서 최대이다.

만일 pLI가 유전질환 유전자의의 우열에 연관이 있다면 장기별 그래프도 전체적인 경향성을 따라 갈 것이다.

```{r}
organ_axis = factor(c("Bone Marrow\nImmune",
               "Brain\nCognition",
               "Ear",
               "Endocrine\nMetabolic",
               "Eye",
               "Face",
               "GI tract", 
               "Heart/Lymphatic\nCardiovasculature",
               "Kidney Renal Tract",
               "Musculature", 
               "Skeleton",
               "Skin",
               "Spinal cord\nPeripheral nerves",
               "Teeth\nDentitian"))
i = 1
d1 <- d %>%
  filter(grepl(organ_list$organ[i], `organ specificity list`)) %>%
  mutate(organ = organ_axis[i])
for(i in 2:14){
  d1 <- rbind(d1, d %>%
    filter(grepl(organ_list$organ[i], `organ specificity list`)) %>%
    mutate(organ = organ_axis[i]))
}
d1$organ <- as.factor(d1$organ)
d1 %>% select(`gene symbol`, `disease mim`, `organ specificity list`, pLI, type, organ)
```

`d1`을 이용해 그래프를 나타내어 보면, 다음과 같고,
```{r, fig.height = 9}
p <- d1 %>%
  group_by(organ, type) %>%
  ggplot(aes(x = pLI, y = organ, fill = organ)) +
  geom_density_ridges(#stat = 'binline', binwidth = 0.02,
                      alpha = 0.6, 
                      jittered_points = TRUE,
                      #position = position_points_jitter(width = 0.05, height = 0),
                      point_shape = 23, point_size = 0.5, point_alpha = 0.5,
                      ) + 
  lims(x=c(-0.00,1.00))+
  facet_wrap(~ type) +
  # theme(legend.position = "none") +
  labs(title = "Organ Specific pLI Distribution",
       y = "") +
  coord_fixed(ratio = 0.25)
p
```
각 장기별 그래프가 전체적인 경향성을 따름을 알 수 있다.

# 3. 결론
유전질환 유전자의 우열을 알아보기 위하여 DDG2P dataset의 organ specificity list와 pLI를 이용해 plotting을 한 결과 우성 유전은 주로 pLI값이 높았고, 열성 유전은 pLI값이 낮았다. 또한 각 장기에서 얻은 그래프가 전체의 분포와 비슷함을 통해 전체적인 경향성을 나타냄을 보였다.
다만, 열성 유전에서는 pLI가 0인 peak가 지배적으로 나타나긴 하지만, 우성 유전에서도 0 근처의 peak가 높게 나타나고 크기가 반대인 장기도 존재하므로 pLI가 작은 유전자라고 해서 열성 유전이라고 할 수는 없을 것이다. 또한 중간 크기의 pLI에서는 우열을 따질 방법이 없으므로 이 역시 부족한 부분이라 할 수 있을 것이다.

# 4. 제언

피드백 받은 내용을 바탕으로 plot을 보강해 보고자 한다.

먼저 facet의 이름이 약어이기 때문에 이해하기 힘들다는 의견이 있어서 facet name을 풀어서 설명했다.
또한 각 유전자의 pLI에서 어느 부분에서 tolerency가 결정되는 지를 표현하기 위해서 intolerent의 경계를 0.1로 설정하고 붉은 배경으로 나타냈고, tolerent의 경계르ㄹ 0.9로 설정하고 푸른 배경으로 나타냈다.
생략한 y축 label을 나타냈고, legend를 추가하여 읽기 편하게 했다. figure height를 큰 값으로 고정해서 organ 사이 간격을 늘렸다.
마지막으로 y축을 약어로 변경하고 y축의 organ 순서와 범례 순서를 일치시켜서 직관성을 높였다. 

```{r, fig.height = 9}
abbs <- c('BM&I', 'B&C', 'Ear', 'E&M', 'Eye', 'Face', 'GIT', 'H/L/CV', 'KRT', 'MC', 'SK', 'Skin', 'SC/PN', 'T&D')
d1 %>%
  group_by(organ, type) %>%
  ggplot(aes(x = pLI, y = organ, fill = organ)) +
  geom_rect(xmin = 0, xmax = 0.1,
            ymin = 0.75, ymax = sum(organ_axis!=0)+2,
            fill = rgb(205, 40, 54, maxColorValue = 255)) +
  geom_rect(xmin = 0.9, xmax = 1,
            ymin = 0.75, ymax = sum(organ_axis!=0)+2,
            fill = rgb(106, 144, 202, maxColorValue = 255)) +
  geom_density_ridges(alpha = 0.6, 
                      jittered_points = TRUE,
                      point_shape = 23, point_size = 0.5, point_alpha = 0.5,) + 
  lims(x = c(-0.00, 1.00)) +
  facet_wrap(~ type,
             labeller = as_labeller(c('AD' = 'AD: Autosomal Dominant',
                                      'AR' = 'AR: Austosomal Recessive'))) +
  labs(title = "Organ Specific pLI Distribution",
       y = "organ") +
  guides(fill = guide_legend(keywidth=0.35,
                             keyheight=0.35,
                             default.unit="inch")) +
  geom_text(x = 0.1, y = 0.65, label = "intolerent") +
  geom_text(x = 0.9, y = 0.65, label = "tolerent") +
  geom_text(x = 0.2, y = 15.5, label = "<0.1") +
  geom_text(x = 0.8, y = 15.5, label = ">0.9") +
  geom_vline(xintercept = 0.1) +
  geom_vline(xintercept = 0.9) +
  scale_y_discrete(limits = rev(levels(organ_axis)),
                   labels = rev(abbs)) +
  scale_fill_discrete(limits = levels(organ_axis), 
                      labels = paste(abbs, organ_axis, sep = ': ')) +
  coord_fixed(ratio = 0.25)
```

피드백을 받아 plot을 수정해 보았다. 분명히 같은 plot이지만 더 많은 정보를 명확하게 전달할 수 있게 된 것 같다. 